{% extends 'admin_panel/base.html' %}
{% load static %}

{% block title %}Job Sheet #{{ job_sheet.id }} - TechVerse Admin{% endblock %}

{% block page_title %}Job Sheet #{{ job_sheet.id }}{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
    <!-- Header Section -->
    <div style="background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 25px; margin-bottom: 25px;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
            <div>
                <h2 style="color: white; margin: 0 0 10px 0;">Job Sheet #{{ job_sheet.id }}</h2>
                <div style="color: rgba(255,255,255,0.6);">
                    Service Request: <a href="{% url 'admin_panel:edit_service' job_sheet.service_request.id %}" style="color: #60a5fa;">#{{ job_sheet.service_request.id }}</a>
                    | Category: {{ job_sheet.service_request.service_category.name }}
                </div>
            </div>
            <div style="text-align: right;">
                {% if job_sheet.approval_status == 'PENDING' %}
                    <span class="status-badge status-pending" style="font-size: 14px; padding: 8px 16px;">⏳ Pending Approval</span>
                {% elif job_sheet.approval_status == 'APPROVED' %}
                    <span class="status-badge status-completed" style="font-size: 14px; padding: 8px 16px;">✓ Approved</span>
                {% elif job_sheet.approval_status == 'DECLINED' %}
                    <span class="status-badge status-cancelled" style="font-size: 14px; padding: 8px 16px;">✗ Declined</span>
                {% endif %}
                <div style="color: rgba(255,255,255,0.5); font-size: 12px; margin-top: 8px;">
                    Created: {{ job_sheet.created_at|date:"M d, Y H:i" }}
                </div>
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">
        <!-- Customer Information -->
        <div class="stat-card" style="padding: 25px;">
            <h3 style="color: #60a5fa; margin: 0 0 20px 0; font-size: 18px;">
                <i class="fas fa-user"></i> Customer Information
            </h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div>
                    <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 4px;">Name</div>
                    <div style="color: white; font-weight: 600;">{{ job_sheet.customer_name }}</div>
                </div>
                <div>
                    <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 4px;">Contact</div>
                    <div style="color: white; font-weight: 600;">{{ job_sheet.customer_contact }}</div>
                </div>
                <div>
                    <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 4px;">Service Address</div>
                    <div style="color: white; font-weight: 600;">{{ job_sheet.service_address }}</div>
                </div>
            </div>
        </div>

        <!-- Technician Information -->
        <div class="stat-card" style="padding: 25px;">
            <h3 style="color: #60a5fa; margin: 0 0 20px 0; font-size: 18px;">
                <i class="fas fa-user-cog"></i> Technician Information
            </h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div>
                    <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 4px;">Name</div>
                    <div style="color: white; font-weight: 600;">{{ job_sheet.created_by.name }}</div>
                </div>
                <div>
                    <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 4px;">Email</div>
                    <div style="color: white; font-weight: 600;">{{ job_sheet.created_by.email }}</div>
                </div>
                <div>
                    <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 4px;">Phone</div>
                    <div style="color: white; font-weight: 600;">{{ job_sheet.created_by.phone|default:"N/A" }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Equipment Details -->
    <div class="stat-card" style="padding: 25px; margin-bottom: 25px;">
        <h3 style="color: #60a5fa; margin: 0 0 20px 0; font-size: 18px;">
            <i class="fas fa-tools"></i> Equipment Details
        </h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 4px;">Equipment Type</div>
                <div style="color: white; font-weight: 600;">{{ job_sheet.equipment_type }}</div>
            </div>
            <div>
                <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 4px;">Serial Number</div>
                <div style="color: white; font-weight: 600;">{{ job_sheet.serial_number|default:"N/A" }}</div>
            </div>
            <div>
                <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 4px;">Brand/Make</div>
                <div style="color: white; font-weight: 600;">{{ job_sheet.equipment_brand|default:"N/A" }}</div>
            </div>
            <div>
                <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 4px;">Model</div>
                <div style="color: white; font-weight: 600;">{{ job_sheet.equipment_model|default:"N/A" }}</div>
            </div>
        </div>
    </div>

    <!-- Problem & Work Performed -->
    <div class="stat-card" style="padding: 25px; margin-bottom: 25px;">
        <h3 style="color: #60a5fa; margin: 0 0 20px 0; font-size: 18px;">
            <i class="fas fa-clipboard-list"></i> Problem & Work Performed
        </h3>
        <div style="margin-bottom: 20px;">
            <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 8px;">Problem Description</div>
            <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; color: white; white-space: pre-wrap;">{{ job_sheet.problem_description }}</div>
        </div>
        <div>
            <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 8px;">Work Performed</div>
            <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; color: white; white-space: pre-wrap;">{{ job_sheet.work_performed }}</div>
        </div>
    </div>

    <!-- Time Record -->
    <div class="stat-card" style="padding: 25px; margin-bottom: 25px;">
        <h3 style="color: #60a5fa; margin: 0 0 20px 0; font-size: 18px;">
            <i class="fas fa-clock"></i> Time Record
        </h3>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
            <div>
                <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 4px;">Date</div>
                <div style="color: white; font-weight: 600;">{{ job_sheet.date_of_service|date:"M d, Y" }}</div>
            </div>
            <div>
                <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 4px;">Start Time</div>
                <div style="color: white; font-weight: 600;">{{ job_sheet.start_time|time:"H:i" }}</div>
            </div>
            <div>
                <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 4px;">Finish Time</div>
                <div style="color: white; font-weight: 600;">{{ job_sheet.finish_time|time:"H:i" }}</div>
            </div>
            <div>
                <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 4px;">Total Time</div>
                <div style="color: #60a5fa; font-weight: 600;">{{ job_sheet.total_time_taken }}</div>
            </div>
        </div>
    </div>

    <!-- Materials Used -->
    <div class="stat-card" style="padding: 25px; margin-bottom: 25px;">
        <h3 style="color: #60a5fa; margin: 0 0 20px 0; font-size: 18px;">
            <i class="fas fa-box"></i> Materials Used
        </h3>
        {% if job_sheet.materials.all %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Item Description</th>
                        <th style="text-align: right;">Quantity</th>
                        <th style="text-align: right;">Unit Cost</th>
                        <th style="text-align: right;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for material in job_sheet.materials.all %}
                    <tr>
                        <td>{{ material.date_used|date:"M d, Y" }}</td>
                        <td>{{ material.item_description }}</td>
                        <td style="text-align: right;">{{ material.quantity }}</td>
                        <td style="text-align: right;">₹{{ material.unit_cost }}</td>
                        <td style="text-align: right; font-weight: 600;">₹{{ material.total_cost }}</td>
                    </tr>
                    {% endfor %}
                    <tr style="border-top: 2px solid rgba(255,255,255,0.2);">
                        <td colspan="4" style="text-align: right; font-weight: 700; color: #60a5fa;">Total Material Cost:</td>
                        <td style="text-align: right; font-weight: 700; color: #22c55e; font-size: 18px;">₹{{ total_material_cost }}</td>
                    </tr>
                </tbody>
            </table>
        {% else %}
            <div style="text-align: center; color: rgba(255,255,255,0.5); padding: 40px;">
                <i class="fas fa-inbox" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px;"></i>
                <div>No materials were used in this job.</div>
            </div>
        {% endif %}
    </div>

    <!-- Approval Status -->
    {% if job_sheet.approval_status == 'APPROVED' and job_sheet.approved_at %}
    <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="fas fa-check-circle" style="font-size: 32px; color: #22c55e;"></i>
            <div>
                <div style="color: #22c55e; font-weight: 700; font-size: 16px; margin-bottom: 5px;">Approved by Customer</div>
                <div style="color: rgba(255,255,255,0.7); font-size: 14px;">Approved on {{ job_sheet.approved_at|date:"M d, Y H:i" }}</div>
            </div>
        </div>
    </div>
    {% elif job_sheet.approval_status == 'DECLINED' %}
    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
        <div style="display: flex; align-items: start; gap: 15px;">
            <i class="fas fa-times-circle" style="font-size: 32px; color: #ef4444;"></i>
            <div style="flex: 1;">
                <div style="color: #ef4444; font-weight: 700; font-size: 16px; margin-bottom: 10px;">Declined by Customer</div>
                {% if job_sheet.declined_reason %}
                <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 5px;">Reason:</div>
                <div style="color: white; font-size: 14px; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">{{ job_sheet.declined_reason }}</div>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="fas fa-clock" style="font-size: 32px; color: #fbbf24;"></i>
            <div>
                <div style="color: #fbbf24; font-weight: 700; font-size: 16px; margin-bottom: 5px;">Pending Customer Approval</div>
                <div style="color: rgba(255,255,255,0.7); font-size: 14px;">Waiting for customer to review and approve this job sheet</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div style="display: flex; gap: 15px; justify-content: flex-end;">
        <a href="{% url 'admin_panel:services' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Services
        </a>
        <a href="{% url 'admin_panel:job_sheets' %}" class="btn btn-secondary">
            <i class="fas fa-list"></i> All Job Sheets
        </a>
        <form method="post" action="{% url 'admin_panel:delete_job_sheet' job_sheet.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this job sheet? This action cannot be undone.');">
            {% csrf_token %}
            <button type="submit" class="btn btn-secondary" style="background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.3); color: #ef4444;">
                <i class="fas fa-trash"></i> Delete Job Sheet
            </button>
        </form>
    </div>
</div>
{% endblock %}