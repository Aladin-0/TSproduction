{% extends 'admin_panel/base.html' %}

{% block title %}Services Management - TechVerse Admin{% endblock %}

{% block page_title %}Services Management{% endblock %}

{% block extra_css %}
<style>
    /* Fix dropdown visibility */
    .form-control option {
        background-color: #1a1a1a;
        color: white;
        padding: 10px;
    }
    
    .form-control option:hover {
        background-color: #2a2a2a;
    }
    
    .form-control {
        background-color: rgba(255,255,255,0.05);
        color: white;
        border: 1px solid rgba(255,255,255,0.15);
    }

    /* Page container */
    .services-container {
        max-width: 100%;
        overflow-x: auto;
    }

    /* Filters Section */
    .filters {
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 150px;
    }

    .filter-label {
        color: rgba(255,255,255,0.7);
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 25px;
    }

    .stat-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        border-color: rgba(255,255,255,0.2);
    }

    /* Table Container */
    .table-container {
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 25px;
    }

    .table-header {
        padding: 20px 25px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .table-title {
        color: white;
        font-size: 18px;
        font-weight: 600;
        margin: 0;
    }

    /* Table Styles */
    .table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1400px;
    }

    .table thead {
        background: rgba(255,255,255,0.05);
    }

    .table th {
        padding: 16px;
        text-align: left;
        color: rgba(255,255,255,0.7);
        font-weight: 600;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        white-space: nowrap;
    }

    .table td {
        padding: 16px;
        color: rgba(255,255,255,0.9);
        border-bottom: 1px solid rgba(255,255,255,0.05);
        vertical-align: middle;
    }

    .table tbody tr {
        transition: all 0.2s ease;
    }

    .table tbody tr:hover {
        background: rgba(255,255,255,0.03);
    }

    /* User Avatar */
    .user-avatar {
        background: linear-gradient(135deg, #60a5fa, #3b82f6);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
    }

    /* Status Badges */
    .status-badge {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        display: inline-block;
    }

    .status-pending {
        background: rgba(251, 191, 36, 0.15);
        color: #fbbf24;
        border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .status-processing {
        background: rgba(96, 165, 250, 0.15);
        color: #60a5fa;
        border: 1px solid rgba(96, 165, 250, 0.3);
    }

    .status-completed {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .status-cancelled {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    /* Buttons */
    .btn {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #60a5fa, #3b82f6);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    .btn-secondary {
        background: rgba(255,255,255,0.1);
        color: rgba(255,255,255,0.8);
        border: 1px solid rgba(255,255,255,0.15);
    }

    .btn-secondary:hover {
        background: rgba(255,255,255,0.15);
        transform: translateY(-1px);
    }

    /* Search Box */
    .search-box {
        position: relative;
        min-width: 250px;
    }

    .search-box i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(255,255,255,0.4);
    }

    .search-box input {
        padding-left: 38px;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: linear-gradient(135deg, #1a1a1a, #151515);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 12px;
        padding: 30px;
        max-width: 800px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    .modal-header h3 {
        color: white;
        margin: 0;
        font-size: 20px;
    }

    .modal-close {
        background: none;
        border: none;
        color: rgba(255,255,255,0.6);
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: rgba(255,255,255,0.1);
        color: white;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }

    .detail-section h4 {
        color: white;
        margin: 0 0 15px 0;
        font-size: 16px;
        font-weight: 600;
    }

    .detail-row {
        margin-bottom: 12px;
    }

    .detail-label {
        color: rgba(255,255,255,0.6);
        font-size: 12px;
        margin-bottom: 4px;
    }

    .detail-value {
        color: white;
        font-size: 14px;
        font-weight: 500;
    }

    .form-label {
        display: block;
        color: rgba(255,255,255,0.7);
        font-size: 13px;
        margin-bottom: 8px;
        font-weight: 500;
    }

    /* Pagination */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        padding: 20px;
    }

    .pagination a, .pagination .current {
        padding: 8px 16px;
        border-radius: 6px;
        color: rgba(255,255,255,0.8);
        text-decoration: none;
        transition: all 0.2s ease;
        font-size: 14px;
    }

    .pagination a {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
    }

    .pagination a:hover {
        background: rgba(255,255,255,0.1);
        color: white;
    }

    .pagination .current {
        background: linear-gradient(135deg, #60a5fa, #3b82f6);
        color: white;
        font-weight: 600;
    }

    /* Responsive */
    @media (max-width: 1400px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }

        .filters form {
            flex-direction: column;
        }

        .filter-group {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="services-container">
    <!-- Filters -->
    <div class="filters">
        <form method="get" style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap; width: 100%;">
            <div class="filter-group">
                <label class="filter-label">Status</label>
                <select name="status" class="form-control" onchange="this.form.submit()">
                    <option value="">All Status</option>
                    {% for status_key, status_name in status_choices %}
                    <option value="{{ status_key }}" {% if status_filter == status_key %}selected{% endif %}>
                        {{ status_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Category</label>
                <select name="category" class="form-control" onchange="this.form.submit()">
                    <option value="">All Categories</option>
                    {% for category in service_categories %}
                    <option value="{{ category.id }}" {% if category_filter == category.id|stringformat:'s' %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Technician</label>
                <select name="technician" class="form-control" onchange="this.form.submit()">
                    <option value="">All Technicians</option>
                    <option value="unassigned" {% if technician_filter == 'unassigned' %}selected{% endif %}>Unassigned</option>
                    {% for technician in technicians %}
                    <option value="{{ technician.id }}" {% if technician_filter == technician.id|stringformat:'s' %}selected{% endif %}>
                        {{ technician.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" name="search" class="form-control" placeholder="Search services..." 
                       value="{{ search }}">
            </div>

            <button type="submit" class="btn btn-primary">
                <i class="fas fa-filter"></i>
                Filter
            </button>

            {% if status_filter or category_filter or technician_filter or search %}
            <a href="{% url 'admin_panel:services' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i>
                Clear
            </a>
            {% endif %}
        </form>
    </div>

    <!-- Quick Stats -->
    <div class="stats-grid">
        <div class="stat-card" style="padding: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 5px;">SUBMITTED</div>
                    <div style="font-size: 20px; font-weight: 700; color: #fbbf24;">
                        {{ submitted_count }}
                    </div>
                </div>
                <i class="fas fa-clipboard-list" style="color: #fbbf24; font-size: 20px;"></i>
            </div>
        </div>
        
        <div class="stat-card" style="padding: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 5px;">UNASSIGNED</div>
                    <div style="font-size: 20px; font-weight: 700; color: #ef4444;">
                        {{ unassigned_count }}
                    </div>
                </div>
                <i class="fas fa-user-times" style="color: #ef4444; font-size: 20px;"></i>
            </div>
        </div>
        <div class="stat-card" style="padding: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 5px;">IN PROGRESS</div>
                    <div style="font-size: 20px; font-weight: 700; color: #3b82f6;">
                        {{ in_progress_count }}
                    </div>
                </div>
                <i class="fas fa-cog fa-spin" style="color: #3b82f6; font-size: 20px;"></i>
            </div>
        </div>
        
        <div class="stat-card" style="padding: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 5px;">COMPLETED</div>
                    <div style="font-size: 20px; font-weight: 700; color: #10b981;">
                        {{ completed_count }}
                    </div>
                </div>
                <i class="fas fa-check-circle" style="color: #10b981; font-size: 20px;"></i>
            </div>
        </div>
    </div>

    <!-- Services Table -->
    <div class="table-container">
        <div class="table-header">
            <h3 class="table-title">
                Service Requests 
                <span style="color: rgba(255,255,255,0.6); font-weight: 400; font-size: 14px;">
                    ({{ services.paginator.count }} total)
                </span>
            </h3>
        </div>
        
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 100px;">Service ID</th>
                        <th style="width: 200px;">Customer</th>
                        <th style="width: 120px;">Category</th>
                        <th style="width: 200px;">Issue</th>
                        <th style="width: 120px;">Status</th>
                        <th style="width: 150px;">Technician</th>
                        <th style="width: 150px;">Job Sheet</th>
                        <th style="width: 150px;">Location</th>
                        <th style="width: 120px;">Date</th>
                        <th style="width: 150px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for service in services %}
                    <tr>
                        <td>
                            <div>
                                <div style="font-weight: 600; font-size: 16px;">#{{ service.id }}</div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                                    {{ service.request_date|date:"M d, H:i" }}
                                </div>
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="user-avatar" style="width: 35px; height: 35px;">
                                    {{ service.customer.name|first|upper }}
                                </div>
                                <div>
                                    <div style="font-weight: 600;">{{ service.customer.name }}</div>
                                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">{{ service.customer.email }}</div>
                                    {% if service.customer.phone %}
                                    <div style="font-size: 11px; color: rgba(255,255,255,0.5);">
                                        <i class="fas fa-phone"></i> {{ service.customer.phone }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge status-processing">
                                {{ service.service_category.name }}
                            </span>
                        </td>
                        <td>
                            <div>
                                {% if service.issue %}
                                    <div style="font-weight: 600;">{{ service.issue.description }}</div>
                                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">₹{{ service.issue.price }}</div>
                                {% endif %}
                                {% if service.custom_description %}
                                    <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 4px;">
                                        {{ service.custom_description|truncatechars:50 }}
                                    </div>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="status-badge status-{% if service.status == 'SUBMITTED' %}pending{% elif service.status == 'ASSIGNED' or service.status == 'IN_PROGRESS' %}processing{% elif service.status == 'COMPLETED' %}completed{% else %}cancelled{% endif %}">
                                {{ service.status }}
                            </span>
                        </td>
                        <td>
                            {% if service.technician %}
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div class="user-avatar" style="width: 30px; height: 30px; font-size: 12px;">
                                        {{ service.technician.name|first|upper }}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 13px;">{{ service.technician.name }}</div>
                                        {% if service.technician.phone %}
                                        <div style="font-size: 10px; color: rgba(255,255,255,0.5);">{{ service.technician.phone }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% else %}
                                <span style="color: rgba(255,255,255,0.5); font-style: italic;">Unassigned</span>
                            {% endif %}
                        </td>
                        
                        <!-- Job Sheet Column -->
                        <td>
                            {% if service.job_sheet %}
                                <a href="{% url 'admin_panel:job_sheet_detail' service.job_sheet.id %}" 
                                   class="btn btn-secondary" 
                                   style="padding: 5px 10px; font-size: 12px; display: inline-block; margin-bottom: 5px;">
                                    <i class="fas fa-file-alt"></i> View
                                </a>
                                <div>
                                    {% if service.job_sheet.approval_status == 'PENDING' %}
                                        <span class="status-badge status-pending" style="font-size: 10px;">⏳ Pending</span>
                                    {% elif service.job_sheet.approval_status == 'APPROVED' %}
                                        <span class="status-badge status-completed" style="font-size: 10px;">✓ Approved</span>
                                    {% elif service.job_sheet.approval_status == 'DECLINED' %}
                                        <span class="status-badge status-cancelled" style="font-size: 10px;">✗ Declined</span>
                                    {% endif %}
                                </div>
                            {% else %}
                                <span style="color: rgba(255,255,255,0.4); font-size: 12px; font-style: italic;">
                                    <i class="fas fa-minus-circle"></i> No Sheet
                                </span>
                            {% endif %}
                        </td>
                        
                        <td>
                            {% if service.service_location %}
                                <div style="font-size: 12px;">
                                    <div>{{ service.service_location.city }}, {{ service.service_location.state }}</div>
                                    <div style="color: rgba(255,255,255,0.5);">{{ service.service_location.pincode }}</div>
                                </div>
                            {% else %}
                                <span style="color: rgba(255,255,255,0.5);">No address</span>
                            {% endif %}
                        </td>
                        <td>
                            <div style="font-size: 13px;">
                                {{ service.request_date|date:"M d, Y" }}
                                <div style="color: rgba(255,255,255,0.6); font-size: 11px;">
                                    {{ service.request_date|timesince }} ago
                                </div>
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <button onclick="viewServiceDetails({{ service.id }})" 
                                        class="btn btn-secondary" 
                                        style="padding: 5px 8px; font-size: 12px;"
                                        title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                
                                {% if not service.technician %}
                                <button onclick="quickAssignTechnician({{ service.id }}, '{{ service.customer.name|escapejs }}')" 
                                        class="btn btn-primary" 
                                        style="padding: 5px 8px; font-size: 12px;"
                                        title="Assign Technician">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                                {% endif %}
                                
                                <button onclick="updateServiceStatus({{ service.id }}, '{{ service.status }}')" 
                                        class="btn btn-secondary" 
                                        style="padding: 5px 8px; font-size: 12px;"
                                        title="Update Status">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="10" style="text-align: center; color: rgba(255,255,255,0.6); padding: 60px;">
                            <i class="fas fa-tools" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
                            <div style="font-size: 18px; margin-bottom: 10px;">No service requests found</div>
                            <div style="font-size: 14px;">
                                {% if search or status_filter or category_filter or technician_filter %}
                                    Try adjusting your search criteria or 
                                    <a href="{% url 'admin_panel:services' %}" style="color: #60a5fa;">clear filters</a>
                                {% else %}
                                    Service requests will appear here when customers submit them
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if services.has_other_pages %}
    <div class="pagination">
        {% if services.has_previous %}
            <a href="?page=1{% if status_filter %}&status={{ status_filter }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if technician_filter %}&technician={{ technician_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}">
                <i class="fas fa-angle-double-left"></i> First
            </a>
            <a href="?page={{ services.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if technician_filter %}&technician={{ technician_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}">
                <i class="fas fa-angle-left"></i> Previous
            </a>
        {% endif %}

        <span class="current">
            Page {{ services.number }} of {{ services.paginator.num_pages }}
        </span>

        {% if services.has_next %}
            <a href="?page={{ services.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if technician_filter %}&technician={{ technician_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}">
                Next <i class="fas fa-angle-right"></i>
            </a>
            <a href="?page={{ services.paginator.num_pages }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if technician_filter %}&technician={{ technician_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}">
                Last <i class="fas fa-angle-double-right"></i>
            </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Service Details Modal -->
<div id="serviceDetailsModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Service Request Details</h3>
            <button onclick="closeServiceModal()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="serviceDetailsContent">
            <!-- Content loaded via JavaScript -->
        </div>
    </div>
</div>

<!-- Assign Technician Modal -->
<div id="assignTechnicianModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>Assign Technician</h3>
            <button onclick="closeAssignModal()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="assignTechnicianContent">
            <!-- Content loaded via JavaScript -->
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div id="statusUpdateModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>Update Service Status</h3>
            <button onclick="closeStatusModal()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="statusUpdateContent">
            <!-- Content loaded via JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedServiceId = null;

    // View service details with REAL DATA
    function viewServiceDetails(serviceId) {
        const modal = document.getElementById('serviceDetailsModal');
        const content = document.getElementById('serviceDetailsContent');
        
        content.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #60a5fa;"></i>
                <div style="margin-top: 15px; color: rgba(255,255,255,0.7);">Loading service details...</div>
            </div>
        `;
        
        modal.style.display = 'flex';
        
        // Fetch REAL data from backend
        fetch(`/admin-panel/api/service/${serviceId}/`, {
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            content.innerHTML = `
                <div class="detail-grid">
                    <div class="detail-section">
                        <h4>Service Information</h4>
                        <div class="detail-row">
                            <div class="detail-label">Service ID</div>
                            <div class="detail-value">#${data.id}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Category</div>
                            <div class="detail-value">${data.service_category.name}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Issue</div>
                            <div class="detail-value">${data.issue ? data.issue.description : 'N/A'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">
                                <span class="status-badge status-${data.status == 'SUBMITTED' ? 'pending' : data.status == 'COMPLETED' ? 'completed' : 'processing'}">
                                    ${data.status}
                                </span>
                            </div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Request Date</div>
                            <div class="detail-value">${new Date(data.request_date).toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="detail-section">
                        <h4>Customer Details</h4>
                        <div class="detail-row">
                            <div class="detail-label">Name</div>
                            <div class="detail-value">${data.customer.name}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${data.customer.email}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Phone</div>
                            <div class="detail-value">${data.customer.phone || 'N/A'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Location</div>
                            <div class="detail-value">
                                ${data.service_location.street_address}<br>
                                ${data.service_location.city}, ${data.service_location.state}<br>
                                ${data.service_location.pincode}
                            </div>
                        </div>
                    </div>
                </div>
                ${data.custom_description ? `
                    <div class="detail-section" style="margin-bottom: 20px;">
                        <h4>Description</h4>
                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; color: white;">
                            ${data.custom_description}
                        </div>
                    </div>
                ` : ''}
                <div style="display: flex; gap: 10px; justify-content: end;">
                    <button onclick="closeServiceModal()" class="btn btn-primary">Close</button>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error:', error);
            content.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #ef4444;">
                    <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
                    <div>Error loading service details</div>
                </div>
            `;
        });
    }

    function closeServiceModal() {
        document.getElementById('serviceDetailsModal').style.display = 'none';
    }

    function quickAssignTechnician(serviceId, customerName) {
        selectedServiceId = serviceId;
        const modal = document.getElementById('assignTechnicianModal');
        const content = document.getElementById('assignTechnicianContent');
        
        content.innerHTML = `
            <div style="margin-bottom: 20px;">
                <label class="form-label">Service: #${serviceId}</label>
                <div style="font-size: 14px; color: rgba(255,255,255,0.6);">Customer: ${customerName}</div>
            </div>
            <div style="margin-bottom: 20px;">
                <label class="form-label">Select Technician</label>
                <select id="selectedTechnician" class="form-control">
                    <option value="">Choose a technician...</option>
                    {% for technician in technicians %}
                    <option value="{{ technician.id }}">{{ technician.name }} - {{ technician.email }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="display: flex; gap: 10px; justify-content: end;">
                <button onclick="closeAssignModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="assignTechnician()" class="btn btn-primary">Assign</button>
            </div>
        `;
        
        modal.style.display = 'flex';
    }

    function assignTechnician() {
        const technicianId = document.getElementById('selectedTechnician').value;
        
        if (!technicianId) {
            alert('Please select a technician');
            return;
        }
        
        fetch('{% url "admin_panel:api_assign_service_technician" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                service_id: selectedServiceId,
                technician_id: technicianId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Technician assigned successfully!');
                closeAssignModal();
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error assigning technician');
            console.error(error);
        });
    }

    function closeAssignModal() {
        document.getElementById('assignTechnicianModal').style.display = 'none';
        selectedServiceId = null;
    }

    function updateServiceStatus(serviceId, currentStatus) {
        selectedServiceId = serviceId;
        const modal = document.getElementById('statusUpdateModal');
        const content = document.getElementById('statusUpdateContent');
        
        content.innerHTML = `
            <div style="margin-bottom: 20px;">
                <label class="form-label">Service: #${serviceId}</label>
                <div style="font-size: 14px; color: rgba(255,255,255,0.6);">Current Status: ${currentStatus}</div>
            </div>
            <div style="margin-bottom: 20px;">
                <label class="form-label">New Status</label>
                <select id="newStatus" class="form-control">
                    {% for status_key, status_name in status_choices %}
                    <option value="{{ status_key }}">{{ status_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="display: flex; gap: 10px; justify-content: end;">
                <button onclick="closeStatusModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="updateStatus()" class="btn btn-primary">Update</button>
            </div>
        `;

        
        setTimeout(() => {
            document.getElementById('newStatus').value = currentStatus;
        }, 100);
        
        modal.style.display = 'flex';
    }

    function updateStatus() {
        const newStatus = document.getElementById('newStatus').value;
        
        fetch('{% url "admin_panel:api_update_service_status" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                service_id: selectedServiceId,
                status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Service status updated successfully!');
                closeStatusModal();
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error updating status');
            console.error(error);
        });
    }

    function closeStatusModal() {
        document.getElementById('statusUpdateModal').style.display = 'none';
        selectedServiceId = null;
    }

    // Close modals on outside click
    document.getElementById('serviceDetailsModal').addEventListener('click', function(e) {
        if (e.target === this) closeServiceModal();
    });

    document.getElementById('assignTechnicianModal').addEventListener('click', function(e) {
        if (e.target === this) closeAssignModal();
    });

    document.getElementById('statusUpdateModal').addEventListener('click', function(e) {
        if (e.target === this) closeStatusModal();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeServiceModal();
            closeAssignModal();
            closeStatusModal();
        }
    });
</script>
{% endblock %}