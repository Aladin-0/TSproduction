{% extends 'admin_panel/base.html' %}

{% block title %}Create User - TechVerse Admin{% endblock %}

{% block page_title %}Create New User{% endblock %}

{% block top_actions %}
<a href="{% url 'admin_panel:users' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i>
    Back to Users
</a>
<button form="userForm" type="submit" class="btn btn-primary">
    <i class="fas fa-save"></i>
    Create User
</button>
{% endblock %}

{% block content %}
<div style="max-width: 1000px;">
    <form id="userForm" method="post">
        {% csrf_token %}
        
        <div class="table-container" style="margin-bottom: 30px;">
            <div class="table-header">
                <h3 class="table-title">User Information</h3>
            </div>
            <div style="padding: 30px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" name="name" class="form-control" placeholder="Enter full name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email Address *</label>
                        <input type="email" name="email" class="form-control" placeholder="Enter email address" required>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" name="phone" class="form-control" placeholder="Enter phone number">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Role *</label>
                        <select name="role" id="userRole" class="form-control" required>
                            <option value="">Select Role</option>
                            <option value="CUSTOMER">Customer</option>
                            <option value="TECHNICIAN">Technician</option>
                            <option value="AMC">AMC Customer</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" name="password1" class="form-control" placeholder="Enter password" required>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                            Minimum 8 characters
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Confirm Password *</label>
                        <input type="password" name="password2" class="form-control" placeholder="Confirm password" required>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-container" style="margin-bottom: 30px;">
            <div class="table-header">
                <h3 class="table-title">Preferences</h3>
            </div>
            <div style="padding: 30px;">
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" name="email_notifications" value="true" checked style="width: 18px; height: 18px;">
                            <span>Email Notifications</span>
                        </label>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                            User will receive order updates and service notifications via email
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" name="sms_notifications" value="true" checked style="width: 18px; height: 18px;">
                            <span>SMS Notifications</span>
                        </label>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                            User will receive important updates via SMS
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" name="is_active" value="true" checked style="width: 18px; height: 18px;">
                            <span>Account Active</span>
                        </label>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                            Active users can log in and use the system
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FREE SERVICE CATEGORIES SECTION - NEW -->
        <div class="table-container" id="amcServicesSection" style="margin-bottom: 30px; display: none;">
            <div class="table-header">
                <h3 class="table-title">
                    <i class="fas fa-gift"></i>
                    Free Service Categories
                </h3>
                <span style="font-size: 12px; color: rgba(255,255,255,0.6); font-weight: 400;">
                    AMC Benefits
                </span>
            </div>
            <div style="padding: 30px;">
                <div style="background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981; padding: 12px 15px; border-radius: 6px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-info-circle" style="color: #10b981;"></i>
                        <span style="font-size: 13px; color: rgba(255,255,255,0.8);">
                            Select which service categories will be completely free for this AMC customer. They will not be charged for selected services.
                        </span>
                    </div>
                </div>

                {% if service_categories %}
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    {% for category in service_categories %}
                    <div class="service-category-card" style="background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; transition: all 0.3s ease; cursor: pointer;">
                        <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer; margin: 0;">
                            <input 
                                type="checkbox" 
                                name="free_service_categories" 
                                value="{{ category.id }}"
                                id="new_category_{{ category.id }}"
                                style="width: 20px; height: 20px; margin-top: 2px; cursor: pointer;"
                                onchange="updateCategoryCardStyle(this)"
                            >
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; margin-bottom: 5px;">
                                    {{ category.name }}
                                </div>
                                <div style="font-size: 11px; color: rgba(255,255,255,0.5);">
                                    <i class="fas fa-tools"></i>
                                    {% with issues_count=category.issues.count %}
                                        {{ issues_count }} service{{ issues_count|pluralize }} available
                                    {% endwith %}
                                </div>
                            </div>
                        </label>
                    </div>
                    {% endfor %}
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button type="button" onclick="selectAllServices()" class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;">
                        <i class="fas fa-check-double"></i>
                        Select All
                    </button>
                    <button type="button" onclick="deselectAllServices()" class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;">
                        <i class="fas fa-times"></i>
                        Deselect All
                    </button>
                </div>
                {% else %}
                <div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);">
                    <i class="fas fa-exclamation-circle" style="font-size: 36px; margin-bottom: 10px; opacity: 0.3;"></i>
                    <div>No service categories available</div>
                    <div style="font-size: 12px; margin-top: 5px;">Please create service categories first</div>
                </div>
                {% endif %}
                
                <div style="margin-top: 20px; padding: 12px; background: rgba(96, 165, 250, 0.1); border-radius: 6px; border-left: 3px solid #60a5fa;">
                    <div style="font-size: 12px; color: rgba(255,255,255,0.7);">
                        <i class="fas fa-lightbulb" style="color: #60a5fa;"></i>
                        <strong>Tip:</strong> You can modify these free service benefits later from the user edit page. Selected services will be completely free for this AMC customer.
                    </div>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 15px; justify-content: end;">
            <a href="{% url 'admin_panel:users' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i>
                Cancel
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                Create User
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Form validation
    document.getElementById('userForm').addEventListener('submit', function(e) {
        const password1 = document.querySelector('input[name="password1"]').value;
        const password2 = document.querySelector('input[name="password2"]').value;
        
        if (password1 !== password2) {
            e.preventDefault();
            alert('Passwords do not match');
            return;
        }
        
        if (password1.length < 8) {
            e.preventDefault();
            alert('Password must be at least 8 characters long');
            return;
        }
    });

    // Email validation
    document.querySelector('input[name="email"]').addEventListener('blur', function() {
        const email = this.value;
        if (email) {
            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                this.style.borderColor = '#ef4444';
                this.nextElementSibling?.remove(); // Remove existing error
                const error = document.createElement('div');
                error.style.cssText = 'font-size: 12px; color: #ef4444; margin-top: 5px;';
                error.textContent = 'Please enter a valid email address';
                this.parentNode.appendChild(error);
            } else {
                this.style.borderColor = '';
                this.nextElementSibling?.remove();
            }
        }
    });

    // Phone number formatting
    document.querySelector('input[name="phone"]').addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        if (value.length > 10) value = value.substr(0, 10);
        this.value = value;
    });

    // Show/hide AMC services section based on role selection
    document.getElementById('userRole').addEventListener('change', function() {
        const amcSection = document.getElementById('amcServicesSection');
        const roleInfo = document.getElementById('roleInfo');
        
        // Remove existing role info
        if (roleInfo) roleInfo.remove();
        
        if (this.value === 'AMC') {
            // Show AMC services section
            amcSection.style.display = 'block';
            
            // Scroll to AMC section smoothly
            setTimeout(() => {
                amcSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
            
            // Show AMC info
            const info = document.createElement('div');
            info.id = 'roleInfo';
            info.style.cssText = 'margin-top: 10px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; font-size: 12px; color: #10b981; border-left: 3px solid #10b981;';
            info.innerHTML = '<i class="fas fa-star"></i> <strong>AMC customers</strong> get priority support and selected free services. Configure free services below.';
            this.parentNode.appendChild(info);
        } else {
            // Hide AMC services section
            amcSection.style.display = 'none';
            
            // Uncheck all free service categories when hiding
            document.querySelectorAll('input[name="free_service_categories"]').forEach(cb => {
                cb.checked = false;
                updateCategoryCardStyle(cb);
            });
            
            // Show role-specific info
            if (this.value) {
                const info = document.createElement('div');
                info.id = 'roleInfo';
                info.style.cssText = 'margin-top: 10px; padding: 10px; background: rgba(96, 165, 250, 0.1); border-radius: 6px; font-size: 12px; color: #60a5fa;';
                
                switch(this.value) {
                    case 'CUSTOMER':
                        info.innerHTML = '<i class="fas fa-user"></i> Regular customers can place orders and request services (paid)';
                        break;
                    case 'TECHNICIAN':
                        info.innerHTML = '<i class="fas fa-wrench"></i> Technicians can be assigned to orders and service requests';
                        break;
                }
                
                this.parentNode.appendChild(info);
            }
        }
    });

    // Update visual style of category cards when selected
    function updateCategoryCardStyle(checkbox) {
        const card = checkbox.closest('.service-category-card');
        if (card) {
            if (checkbox.checked) {
                card.style.background = 'rgba(16, 185, 129, 0.15)';
                card.style.borderColor = '#10b981';
                card.style.transform = 'scale(1.02)';
            } else {
                card.style.background = 'rgba(255,255,255,0.05)';
                card.style.borderColor = 'rgba(255,255,255,0.1)';
                card.style.transform = 'scale(1)';
            }
        }
    }

    // Select all services
    function selectAllServices() {
        document.querySelectorAll('input[name="free_service_categories"]').forEach(checkbox => {
            checkbox.checked = true;
            updateCategoryCardStyle(checkbox);
        });
    }

    // Deselect all services
    function deselectAllServices() {
        document.querySelectorAll('input[name="free_service_categories"]').forEach(checkbox => {
            checkbox.checked = false;
            updateCategoryCardStyle(checkbox);
        });
    }

    // Add click handler to cards
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.service-category-card').forEach(card => {
            card.addEventListener('click', function(e) {
                // Only toggle if not clicking the checkbox itself
                if (e.target.type !== 'checkbox') {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        updateCategoryCardStyle(checkbox);
                    }
                }
            });
        });
    });
</script>

<style>
    .service-category-card {
        transition: all 0.3s ease;
    }
    
    .service-category-card:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        border-color: rgba(255,255,255,0.2) !important;
    }
    
    .service-category-card input[type="checkbox"] {
        accent-color: #10b981;
    }
    
    /* Animation for showing AMC section */
    #amcServicesSection {
        animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}