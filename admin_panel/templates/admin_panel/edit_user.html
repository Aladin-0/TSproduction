{% extends 'admin_panel/base.html' %}

{% block title %}Edit User - TechVerse Admin{% endblock %}

{% block page_title %}Edit User: {{ user_obj.name }}{% endblock %}

{% block top_actions %}
<a href="{% url 'admin_panel:users' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i>
    Back to Users
</a>
<button form="userForm" type="submit" class="btn btn-primary">
    <i class="fas fa-save"></i>
    Update User
</button>
{% endblock %}

{% block content %}
<div style="max-width: 1000px; display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
    <!-- Main Form -->
    <div>
        <form id="userForm" method="post">
            {% csrf_token %}
            
            <div class="table-container" style="margin-bottom: 30px;">
                <div class="table-header">
                    <h3 class="table-title">User Information</h3>
                    <div style="display: flex; gap: 10px;">
                        <span class="status-badge {% if user_obj.is_active %}status-completed{% else %}status-cancelled{% endif %}">
                            {% if user_obj.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                        <span class="status-badge status-processing">{{ user_obj.get_role_display }}</span>
                    </div>
                </div>
                <div style="padding: 30px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" name="name" class="form-control" value="{{ user_obj.name }}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Email Address *</label>
                            <input type="email" name="email" class="form-control" value="{{ user_obj.email }}" required>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" name="phone" class="form-control" value="{{ user_obj.phone|default:'' }}">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Role *</label>
                            <select name="role" class="form-control" required>
                                <option value="CUSTOMER" {% if user_obj.role == 'CUSTOMER' %}selected{% endif %}>Customer</option>
                                <option value="TECHNICIAN" {% if user_obj.role == 'TECHNICIAN' %}selected{% endif %}>Technician</option>
                                <option value="AMC" {% if user_obj.role == 'AMC' %}selected{% endif %}>AMC Customer</option>
                                {% if user.is_superuser %}
                                <option value="ADMIN" {% if user_obj.role == 'ADMIN' %}selected{% endif %}>Admin</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-container" style="margin-bottom: 30px;">
                <div class="table-header">
                    <h3 class="table-title">Account Settings</h3>
                </div>
                <div style="padding: 30px;">
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="is_active" {% if user_obj.is_active %}checked{% endif %} style="width: 18px; height: 18px;">
                                <span>Account Active</span>
                            </label>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                                Active users can log in and use the system
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="email_notifications" {% if user_obj.email_notifications %}checked{% endif %} style="width: 18px; height: 18px;">
                                <span>Email Notifications</span>
                            </label>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                                User will receive order updates and service notifications via email
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="sms_notifications" {% if user_obj.sms_notifications %}checked{% endif %} style="width: 18px; height: 18px;">
                                <span>SMS Notifications</span>
                            </label>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                                User will receive important updates via SMS
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; justify-content: end;">
                <a href="{% url 'admin_panel:users' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Back to Users
                </a>
                <button type="button" onclick="resetPassword()" class="btn btn-secondary">
                    <i class="fas fa-key"></i>
                    Reset Password
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Update User
                </button>
            </div>
        </form>
    </div>

    <!-- Sidebar -->
    <div>
        <!-- User Stats -->
        <div class="table-container" style="margin-bottom: 30px;">
            <div class="table-header">
                <h3 class="table-title">User Statistics</h3>
            </div>
            <div style="padding: 20px;">
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Member Since</span>
                        <strong>{{ user_obj.date_joined|date:"M d, Y" }}</strong>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between;">
                        <span>Last Login</span>
                        <strong>
                            {% if user_obj.last_login %}
                                {{ user_obj.last_login|date:"M d, Y" }}
                            {% else %}
                                Never
                            {% endif %}
                        </strong>
                    </div>
                    
                    {% if user_obj.role == 'CUSTOMER' or user_obj.role == 'AMC' %}
                    <div style="display: flex; justify-content: space-between;">
                        <span>Total Orders</span>
                        <strong>{{ user_obj.order_set.count }}</strong>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between;">
                        <span>Service Requests</span>
                        <strong>{{ user_obj.servicerequest_set.count }}</strong>
                    </div>
                    {% endif %}
                    
                    {% if user_obj.role == 'TECHNICIAN' %}
                    <div style="display: flex; justify-content: space-between;">
                        <span>Assigned Orders</span>
                        <strong>{{ user_obj.assigned_orders.count }}</strong>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between;">
                        <span>Assigned Services</span>
                        <strong>{{ user_obj.assigned_services.count }}</strong>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between;">
                        <span>Average Rating</span>
                        <strong>
                            {% if user_obj.ratings_received.count > 0 %}
                                {{ user_obj.ratings_received.all|slice:":1"|first.rating|default:"N/A" }}â˜…
                            {% else %}
                                N/A
                            {% endif %}
                        </strong>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="table-container" style="margin-bottom: 30px;">
            <div class="table-header">
                <h3 class="table-title">Quick Actions</h3>
            </div>
            <div style="padding: 20px;">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    {% if user_obj.role == 'CUSTOMER' or user_obj.role == 'AMC' %}
                    <a href="#" onclick="viewUserOrders()" class="btn btn-secondary" style="text-decoration: none; text-align: center;">
                        <i class="fas fa-shopping-cart"></i>
                        View Orders
                    </a>
                    
                    <a href="#" onclick="viewUserServices()" class="btn btn-secondary" style="text-decoration: none; text-align: center;">
                        <i class="fas fa-tools"></i>
                        View Services
                    </a>
                    {% endif %}
                    
                    {% if user_obj.role == 'TECHNICIAN' %}
                    <a href="#" onclick="viewTechnicianJobs()" class="btn btn-secondary" style="text-decoration: none; text-align: center;">
                        <i class="fas fa-briefcase"></i>
                        View Assigned Jobs
                    </a>
                    
                    <a href="#" onclick="viewTechnicianRatings()" class="btn btn-secondary" style="text-decoration: none; text-align: center;">
                        <i class="fas fa-star"></i>
                        View Ratings
                    </a>
                    {% endif %}
                    
                    <button type="button" onclick="sendPasswordReset()" class="btn btn-secondary">
                        <i class="fas fa-envelope"></i>
                        Send Password Reset
                    </button>
                    
                    {% if not user_obj.is_superuser %}
                    <button type="button" onclick="deleteUser()" class="btn btn-danger">
                        <i class="fas fa-trash"></i>
                        Delete User
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- User Activity -->
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Recent Activity</h3>
            </div>
            <div style="padding: 20px;">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                        Last Login: 
                        {% if user_obj.last_login %}
                            {{ user_obj.last_login|timesince }} ago
                        {% else %}
                            Never logged in
                        {% endif %}
                    </div>
                    
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                        Account Created: {{ user_obj.date_joined|timesince }} ago
                    </div>
                    
                    {% if user_obj.role == 'CUSTOMER' or user_obj.role == 'AMC' %}
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                        Last Order: 
                        {% if user_obj.order_set.exists %}
                            {{ user_obj.order_set.first.order_date|timesince }} ago
                        {% else %}
                            No orders yet
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Form validation
    document.getElementById('userForm').addEventListener('submit', function(e) {
        const email = document.querySelector('input[name="email"]').value;
        const name = document.querySelector('input[name="name"]').value;
        
        if (!email || !name) {
            e.preventDefault();
            alert('Name and email are required');
            return;
        }
    });

    // Email validation
    document.querySelector('input[name="email"]').addEventListener('blur', function() {
        const email = this.value;
        if (email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                this.style.borderColor = '#ef4444';
            } else {
                this.style.borderColor = '';
            }
        }
    });

    // Phone number formatting
    document.querySelector('input[name="phone"]').addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        if (value.length > 10) value = value.substr(0, 10);
        this.value = value;
    });

    // Quick action functions
    function resetPassword() {
        if (confirm('Generate a new password for this user? They will need to use the new password to log in.')) {
            // In a real implementation, this would make an API call
            alert('Password reset email sent to user!');
        }
    }

    function sendPasswordReset() {
        if (confirm('Send password reset email to {{ user_obj.email }}?')) {
            alert('Password reset email sent successfully!');
        }
    }

    function deleteUser() {
        if (confirm('Are you sure you want to delete user "{{ user_obj.name }}"? This action cannot be undone.')) {
            if (confirm('This will permanently delete the user and all associated data. Continue?')) {
                // Create form to delete user
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{% url "admin_panel:delete_user" user_obj.id %}';
                
                // Add CSRF token
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = '{{ csrf_token }}';
                form.appendChild(csrfInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }
    }

    function viewUserOrders() {
        window.open('{% url "admin_panel:orders" %}?search={{ user_obj.email }}', '_blank');
    }

    function viewUserServices() {
        window.open('{% url "admin_panel:services" %}?search={{ user_obj.email }}', '_blank');
    }

    function viewTechnicianJobs() {
        window.open('{% url "admin_panel:orders" %}?technician={{ user_obj.id }}', '_blank');
    }

    function viewTechnicianRatings() {
        alert('Technician ratings view coming soon!');
    }

    // Role change warning
    document.querySelector('select[name="role"]').addEventListener('change', function() {
        const originalRole = '{{ user_obj.role }}';
        if (this.value !== originalRole) {
            const warning = document.createElement('div');
            warning.style.cssText = 'margin-top: 10px; padding: 10px; background: rgba(251, 191, 36, 0.1); border-radius: 6px; font-size: 12px; color: #fbbf24; border-left: 3px solid #fbbf24;';
            warning.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Changing user role will affect their permissions and access level.';
            
            // Remove existing warning
            const existingWarning = this.parentNode.querySelector('div[style*="border-left: 3px solid #fbbf24"]');
            if (existingWarning) existingWarning.remove();
            
            this.parentNode.appendChild(warning);
        }
    });
</script>
{% endblock %}