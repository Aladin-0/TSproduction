{% extends 'admin_panel/base.html' %}

{% block title %}Create Product - TechVerse Admin{% endblock %}

{% block page_title %}Create New Product{% endblock %}

{% block top_actions %}
<a href="{% url 'admin_panel:products' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i>
    Back to Products
</a>
<button form="productForm" type="submit" class="btn btn-primary">
    <i class="fas fa-save"></i>
    Save Product
</button>
{% endblock %}

{% block content %}
<form id="productForm" method="post" enctype="multipart/form-data" style="max-width: 1200px;">
    {% csrf_token %}
    
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
        <!-- Main Product Information -->
        <div>
            <!-- Basic Information -->
            <div class="table-container" style="margin-bottom: 30px;">
                <div class="table-header">
                    <h3 class="table-title">Basic Information</h3>
                </div>
                <div style="padding: 30px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">Product Name *</label>
                            <input type="text" name="name" class="form-control" placeholder="Enter product name" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Brand</label>
                            <input type="text" name="brand" class="form-control" placeholder="Enter brand name">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">Category *</label>
                            <select name="category" class="form-control" required>
                                <option value="">Select Category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Model Number</label>
                            <input type="text" name="model_number" class="form-control" placeholder="Enter model number">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Product Description *</label>
                        <textarea name="description" class="form-control" rows="4" placeholder="Enter detailed product description" required></textarea>
                    </div>
                </div>
            </div>

            <!-- Pricing & Inventory -->
            <div class="table-container" style="margin-bottom: 30px;">
                <div class="table-header">
                    <h3 class="table-title">Pricing & Inventory</h3>
                </div>
                <div style="padding: 30px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label">Price (â‚¹) *</label>
                            <input type="number" name="price" class="form-control" placeholder="0.00" step="0.01" min="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Stock Quantity *</label>
                            <input type="number" name="stock" class="form-control" placeholder="0" min="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Weight (kg)</label>
                            <input type="number" name="weight" class="form-control" placeholder="0.00" step="0.01" min="0">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div class="form-group">
                            <label class="form-label">Dimensions (L x W x H cm)</label>
                            <input type="text" name="dimensions" class="form-control" placeholder="e.g., 30 x 20 x 5">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Delivery Time</label>
                            <input type="text" name="delivery_time_info" class="form-control" placeholder="e.g., Delivered within 2-3 business days">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Features -->
            <div class="table-container" style="margin-bottom: 30px;">
                <div class="table-header">
                    <h3 class="table-title">Features & Specifications</h3>
                </div>
                <div style="padding: 30px;">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">Key Features</label>
                        <textarea name="features" class="form-control" rows="3" placeholder="Enter comma-separated features (e.g., Wireless connectivity, Long battery life, Ergonomic design)"></textarea>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                            Separate each feature with a comma
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Warranty Period</label>
                        <select name="warranty_period" class="form-control">
                            <option value="6 Months">6 Months</option>
                            <option value="1 Year" selected>1 Year</option>
                            <option value="2 Years">2 Years</option>
                            <option value="3 Years">3 Years</option>
                            <option value="5 Years">5 Years</option>
                        </select>
                    </div>
                    
                    <!-- Dynamic Specifications -->
                    <div style="margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <label class="form-label" style="margin: 0;">Technical Specifications</label>
                            <button type="button" onclick="addSpecification()" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-plus"></i>
                                Add Specification
                            </button>
                        </div>
                        
                        <div id="specificationsContainer">
                            <div class="specification-row" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; margin-bottom: 15px;">
                                <input type="text" name="spec_names[]" class="form-control" placeholder="Specification name (e.g., Processor)">
                                <input type="text" name="spec_values[]" class="form-control" placeholder="Specification value (e.g., Intel i7)">
                                <button type="button" onclick="removeSpecification(this)" class="btn btn-danger" style="padding: 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div>
            <!-- Product Images -->
            <div class="table-container" style="margin-bottom: 30px;">
                <div class="table-header">
                    <h3 class="table-title">Product Images</h3>
                </div>
                <div style="padding: 30px;">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">Main Product Image *</label>
                        <div style="border: 2px dashed rgba(255,255,255,0.2); border-radius: 8px; padding: 30px; text-align: center; margin-bottom: 15px;" id="mainImageDrop">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 36px; color: rgba(255,255,255,0.3); margin-bottom: 15px;"></i>
                            <div style="margin-bottom: 10px;">Drag & drop image here or</div>
                            <input type="file" name="image" id="mainImage" accept="image/*" style="display: none;" required>
                            <button type="button" onclick="document.getElementById('mainImage').click()" class="btn btn-secondary">
                                Choose File
                            </button>
                        </div>
                        <div id="mainImagePreview" style="display: none;">
                            <img id="mainImageImg" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px;">
                            <button type="button" onclick="removeMainImage()" class="btn btn-danger" style="margin-top: 10px; width: 100%;">
                                Remove Image
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Additional Images</label>
                        <div style="border: 2px dashed rgba(255,255,255,0.2); border-radius: 8px; padding: 20px; text-align: center;" id="additionalImagesDrop">
                            <i class="fas fa-images" style="font-size: 24px; color: rgba(255,255,255,0.3); margin-bottom: 10px;"></i>
                            <div style="margin-bottom: 10px; font-size: 14px;">Upload additional images</div>
                            <input type="file" name="additional_images" id="additionalImages" accept="image/*" multiple style="display: none;">
                            <button type="button" onclick="document.getElementById('additionalImages').click()" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">
                                Choose Files
                            </button>
                        </div>
                        <div id="additionalImagesPreview" style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <!-- Additional image previews will appear here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Settings -->
            <div class="table-container" style="margin-bottom: 30px;">
                <div class="table-header">
                    <h3 class="table-title">Product Settings</h3>
                </div>
                <div style="padding: 30px;">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" name="is_active" value="true" checked style="width: 18px; height: 18px;">
                            <span>Product is active</span>
                        </label>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                            Active products are visible to customers
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" name="is_featured" value="true" style="width: 18px; height: 18px;">
                            <span>Featured product</span>
                        </label>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                            Featured products appear in special sections
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">SEO Meta Description</label>
                        <textarea name="meta_description" class="form-control" rows="3" placeholder="Enter meta description for SEO (max 160 characters)" maxlength="160"></textarea>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px;">
                            This will be used for search engine results
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="table-container">
                <div class="table-header">
                    <h3 class="table-title">Quick Actions</h3>
                </div>
                <div style="padding: 20px;">
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-save"></i>
                        Save Product
                    </button>
                    
                    <button type="button" onclick="saveDraft()" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-file-alt"></i>
                        Save as Draft
                    </button>
                    
                    <a href="{% url 'admin_panel:products' %}" class="btn btn-secondary" style="width: 100%; text-align: center; display: block; text-decoration: none;">
                        <i class="fas fa-times"></i>
                        Cancel
                    </a>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    // Image preview functionality
    document.getElementById('mainImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('mainImageImg').src = e.target.result;
                document.getElementById('mainImagePreview').style.display = 'block';
                document.getElementById('mainImageDrop').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    });

    function removeMainImage() {
        document.getElementById('mainImage').value = '';
        document.getElementById('mainImagePreview').style.display = 'none';
        document.getElementById('mainImageDrop').style.display = 'block';
    }

    // Additional images preview
    document.getElementById('additionalImages').addEventListener('change', function(e) {
        const container = document.getElementById('additionalImagesPreview');
        container.innerHTML = '';
        
        Array.from(e.target.files).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.innerHTML = `
                    <img src="${e.target.result}" style="width: 100%; height: 80px; object-fit: cover; border-radius: 4px;">
                    <button type="button" onclick="removeAdditionalImage(${index})" class="btn btn-danger" style="margin-top: 5px; width: 100%; padding: 2px; font-size: 10px;">
                        Remove
                    </button>
                `;
                container.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    });

    function removeAdditionalImage(index) {
        // Implementation for removing specific additional image
        console.log('Remove additional image:', index);
    }

    // Specifications management
    function addSpecification() {
        const container = document.getElementById('specificationsContainer');
        const div = document.createElement('div');
        div.className = 'specification-row';
        div.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; margin-bottom: 15px;';
        div.innerHTML = `
            <input type="text" name="spec_names[]" class="form-control" placeholder="Specification name">
            <input type="text" name="spec_values[]" class="form-control" placeholder="Specification value">
            <button type="button" onclick="removeSpecification(this)" class="btn btn-danger" style="padding: 10px;">
                <i class="fas fa-trash"></i>
            </button>
        `;
        container.appendChild(div);
    }

    function removeSpecification(button) {
        button.closest('.specification-row').remove();
    }

    // Auto-generate slug from name
    document.querySelector('input[name="name"]').addEventListener('input', function() {
        // Auto-slug generation could be implemented here
        console.log('Product name changed:', this.value);
    });

    // Form submission
    document.getElementById('productForm').addEventListener('submit', function(e) {
        // Don't prevent default - let form submit normally
        
        // Basic validation
        const name = document.querySelector('input[name="name"]').value.trim();
        const price = document.querySelector('input[name="price"]').value;
        const stock = document.querySelector('input[name="stock"]').value;
        const category = document.querySelector('select[name="category"]').value;
        const description = document.querySelector('textarea[name="description"]').value.trim();
        const mainImage = document.querySelector('input[name="image"]').files[0];
        
        if (!name || !price || !stock || !category || !description || !mainImage) {
            e.preventDefault();
            alert('Please fill in all required fields and upload a main image');
            return;
        }
        
        if (parseFloat(price) <= 0) {
            e.preventDefault();
            alert('Price must be greater than 0');
            return;
        }
        
        if (parseInt(stock) < 0) {
            e.preventDefault();
            alert('Stock cannot be negative');
            return;
        }
        
        // Show loading state
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Product...';
        submitBtn.disabled = true;
        
        // Form will submit normally to Django view
    });

    // Save as draft
    function saveDraft() {
        alert('Product saved as draft!');
    }

    // Drag and drop for images
    ['mainImageDrop', 'additionalImagesDrop'].forEach(id => {
        const element = document.getElementById(id);
        
        element.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.backgroundColor = 'rgba(255,255,255,0.05)';
        });
        
        element.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.backgroundColor = 'transparent';
        });
        
        element.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.backgroundColor = 'transparent';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                if (id === 'mainImageDrop') {
                    document.getElementById('mainImage').files = files;
                    document.getElementById('mainImage').dispatchEvent(new Event('change'));
                } else {
                    document.getElementById('additionalImages').files = files;
                    document.getElementById('additionalImages').dispatchEvent(new Event('change'));
                }
            }
        });
    });
</script>
{% endblock %}