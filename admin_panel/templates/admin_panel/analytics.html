{% extends 'admin_panel/base.html' %}

{% block title %}Analytics - TechVerse Admin{% endblock %}

{% block page_title %}Analytics Dashboard{% endblock %}

{% block top_actions %}
<button class="btn btn-secondary" onclick="window.print()">
    <i class="fas fa-print"></i>
    Print Report
</button>
<button class="btn btn-secondary" onclick="refreshData()">
    <i class="fas fa-sync"></i>
    Refresh Data
</button>
{% endblock %}

{% block content %}
<!-- Date Range Filter -->
<div class="filters" style="margin-bottom: 30px;">
    <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
        <div class="filter-group">
            <label class="filter-label">Date Range</label>
            <select id="dateRange" class="form-control" style="min-width: 150px;" onchange="updateDateRange()">
                <option value="7">Last 7 days</option>
                <option value="30" selected>Last 30 days</option>
                <option value="90">Last 3 months</option>
                <option value="365">Last year</option>
            </select>
        </div>
        
        <button class="btn btn-primary" onclick="applyDateFilter()">
            <i class="fas fa-filter"></i>
            Apply Filter
        </button>
    </div>
</div>

<!-- Key Metrics -->
<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); margin-bottom: 40px;">
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Total Revenue</div>
            <div class="stat-icon" style="background: rgba(16, 185, 129, 0.2); color: #10b981;">
                <i class="fas fa-rupee-sign"></i>
            </div>
        </div>
        <div class="stat-value">₹{{ total_revenue|floatformat:0 }}</div>
        <div class="stat-change positive">
            <i class="fas fa-arrow-up"></i>
            {{ revenue_growth|floatformat:1 }}% from last period
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Total Orders</div>
            <div class="stat-icon" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6;">
                <i class="fas fa-shopping-cart"></i>
            </div>
        </div>
        <div class="stat-value">{{ total_orders }}</div>
        <div class="stat-change positive">
            <i class="fas fa-arrow-up"></i>
            +{{ order_growth|floatformat:1 }}% from last period
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Avg. Order Value</div>
            <div class="stat-icon" style="background: rgba(168, 85, 247, 0.2); color: #a855f7;">
                <i class="fas fa-chart-line"></i>
            </div>
        </div>
        <div class="stat-value">₹{{ avg_order_value|floatformat:0 }}</div>
        <div class="stat-change {% if aov_growth >= 0 %}positive{% else %}negative{% endif %}">
            <i class="fas fa-arrow-{% if aov_growth >= 0 %}up{% else %}down{% endif %}"></i>
            {{ aov_growth|floatformat:1 }}% from last period
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Total Customers</div>
            <div class="stat-icon" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24;">
                <i class="fas fa-users"></i>
            </div>
        </div>
        <div class="stat-value">{{ total_customers }}</div>
        <div class="stat-change positive">
            <i class="fas fa-arrow-up"></i>
            +{{ customer_growth|floatformat:1 }}% from last period
        </div>
    </div>
</div>

<!-- Charts Section -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-bottom: 40px;">
    <!-- Revenue Chart -->
    <div class="table-container">
        <div class="table-header">
            <h3 class="table-title">Revenue Overview (Last 12 Months)</h3>
        </div>
        <div style="padding: 25px;">
            <canvas id="revenueChart" style="width: 100%; height: 300px;"></canvas>
        </div>
    </div>

    <!-- Top Products -->
    <div class="table-container">
        <div class="table-header">
            <h3 class="table-title">Top Products</h3>
        </div>
        <div style="padding: 25px;">
            <div style="display: flex; flex-direction: column; gap: 15px;">
                {% for product in top_products %}
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; background: rgba(59, 130, 246, 0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-box" style="color: #3b82f6;"></i>
                        </div>
                        <div>
                            <div style="font-weight: 600;">{{ product.product__name|truncatechars:25 }}</div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">{{ product.total_quantity }} sold</div>
                        </div>
                    </div>
                    <div style="font-weight: 600;">₹{{ product.total_sales|floatformat:0 }}</div>
                </div>
                {% empty %}
                <div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">
                    No sales data available
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Additional Analytics -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px;">
    <!-- Orders Chart -->
    <div class="table-container">
        <div class="table-header">
            <h3 class="table-title">Orders Trend (Last 30 Days)</h3>
        </div>
        <div style="padding: 25px;">
            <canvas id="ordersChart" style="width: 100%; height: 250px;"></canvas>
        </div>
    </div>

    <!-- Service Requests Chart -->
    <div class="table-container">
        <div class="table-header">
            <h3 class="table-title">Service Requests (Last 30 Days)</h3>
        </div>
        <div style="padding: 25px;">
            <canvas id="servicesChart" style="width: 100%; height: 250px;"></canvas>
        </div>
    </div>
</div>

<!-- Performance Metrics -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
    <!-- Order Status Distribution -->
    <div class="table-container">
        <div class="table-header">
            <h3 class="table-title">Order Status Distribution</h3>
        </div>
        <div style="padding: 25px;">
            <div style="display: flex; flex-direction: column; gap: 20px;">
                {% for status in order_status_distribution %}
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span>{{ status.status }}</span>
                        <strong>{{ status.count }} ({{ status.percentage|floatformat:1 }}%)</strong>
                    </div>
                    <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                        <div style="width: {{ status.percentage }}%; height: 100%; background: linear-gradient(135deg, 
                            {% if status.status == 'PENDING' %}#fbbf24, #f59e0b
                            {% elif status.status == 'PROCESSING' %}#3b82f6, #2563eb
                            {% elif status.status == 'SHIPPED' %}#8b5cf6, #7c3aed
                            {% elif status.status == 'DELIVERED' %}#10b981, #059669
                            {% else %}#ef4444, #dc2626{% endif %});"></div>
                    </div>
                </div>
                {% empty %}
                <div style="text-align: center; color: rgba(255,255,255,0.5);">No order data</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Top Cities -->
    <div class="table-container">
        <div class="table-header">
            <h3 class="table-title">Top Cities by Orders</h3>
        </div>
        <div style="padding: 25px;">
            <div style="display: flex; flex-direction: column; gap: 15px;">
                {% for city in top_cities %}
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600;">{{ city.shipping_address__city }}</div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.6);">{{ city.shipping_address__state }}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 80px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                            <div style="width: {% if top_cities %}{% widthratio city.order_count top_cities.0.order_count 100 %}{% else %}0{% endif %}%; height: 100%; background: #3b82f6;"></div>
                        </div>
                        <strong>{{ city.order_count }}</strong>
                    </div>
                </div>
                {% empty %}
                <div style="text-align: center; color: rgba(255,255,255,0.5);">No location data</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="table-container">
        <div class="table-header">
            <h3 class="table-title">Recent Activity</h3>
        </div>
        <div style="padding: 25px;">
            <div style="display: flex; flex-direction: column; gap: 15px;">
                {% for activity in recent_activities %}
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 32px; height: 32px; background: rgba({{ activity.color }}, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-{{ activity.icon }}" style="color: rgb({{ activity.color }}); font-size: 12px;"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 13px; font-weight: 600;">{{ activity.title }}</div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.6);">{{ activity.description }}</div>
                    </div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.5);">{{ activity.time }}</div>
                </div>
                {% empty %}
                <div style="text-align: center; color: rgba(255,255,255,0.5);">No recent activity</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize charts when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
    });

    function initializeCharts() {
        // Revenue Chart - Using real data from backend
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        const revenueData = {{ monthly_revenue|safe }};
        
        new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: revenueData.map(item => item.month),
                datasets: [{
                    label: 'Revenue (₹)',
                    data: revenueData.map(item => item.amount),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)',
                            callback: function(value) {
                                return '₹' + (value / 1000) + 'K';
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    }
                }
            }
        });

        // Orders Chart - Using real data
        const ordersCtx = document.getElementById('ordersChart').getContext('2d');
        const ordersData = {{ daily_orders|safe }};
        
        new Chart(ordersCtx, {
            type: 'bar',
            data: {
                labels: ordersData.map(item => item.day),
                datasets: [{
                    label: 'Orders',
                    data: ordersData.map(item => item.count),
                    backgroundColor: '#3b82f6',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)',
                            stepSize: 1
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    }
                }
            }
        });

        // Services Chart - Using real data
        const servicesCtx = document.getElementById('servicesChart').getContext('2d');
        const servicesData = {{ daily_services|safe }};
        
        new Chart(servicesCtx, {
            type: 'line',
            data: {
                labels: servicesData.map(item => item.day),
                datasets: [{
                    label: 'Service Requests',
                    data: servicesData.map(item => item.count),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)',
                            stepSize: 1
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    }
                }
            }
        });
    }

    // Date range functions
    function updateDateRange() {
        const dateRange = document.getElementById('dateRange').value;
        console.log('Date range changed to:', dateRange);
    }

    function applyDateFilter() {
        const dateRange = document.getElementById('dateRange').value;
        
        // Show loading state
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        btn.disabled = true;
        
        // Reload page with date range parameter
        window.location.href = `?days=${dateRange}`;
    }

    // Refresh data
    function refreshData() {
        console.log('Refreshing analytics data');
        const refreshBtn = event.target.closest('button');
        const originalText = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        refreshBtn.disabled = true;
        
        // Reload the page
        setTimeout(() => {
            location.reload();
        }, 500);
    }
</script>
{% endblock %}